function selectChange(){g_id=d3.select("#selected-station").property("value"),selectSite(sitelist,g_id)}function onMarkerClick(t){selectSite(sitelist,t.target.g_id)}function selectSite(t,e){var a=t.filter(function(t){return t.G_ID===e})[0];d3.select("#selected-station").property("value",e),sitemap.panTo([a.LAT,a.LON]),highlightMarker.setLatLng([a.LAT,a.LON]),highlightMarker.setIcon(highlightIcon),highlightMarker.addTo(sitemap),plotSite(e)}function updateStatsRow(t){var e,a,r=d3.timeFormat("%b %e, %Y"),i=d3.timeFormat("%Y"),n=sitelist.filter(function(e){return e.G_ID===t[0].G_ID})[0],l=_.maxBy(t,"val"),o=_.maxBy(t,"day"),s=_.uniqBy(t,"wy"),c=s.length,d=_.maxBy(s,"wy").wy,m=calcWaterYear(new Date),u=_.filter(t,{wy:m});if(d===m){var h={};if("Rain"===n.type)h=_.maxBy(u,"oldval"),e=h.oldval.toFixed(2);else{var h=_.maxBy(u,"val");e=h.val.toFixed(2)}a=r(h.day)}else e="No Data",a="--";var g="Most Recent",p="",f="Max This Year",y="Highest Recorded",v=r(l.day);"Rain"==n.type&&(g="Inches This Year",p="As Of ",f="Wettest Day This Year",y="Wettest Year",v=i(l.day)),d3.select(".quick-stats.recent").html("<small>"+g+"</small><br />"+o.val.toFixed(2)+" <br /><small>"+p+r(o.day)+"</small>"),d3.select(".quick-stats.count").html("<small>Years Measured</small><br />"+c),d3.select(".quick-stats.max-currentyear").html("<small>"+f+"</small><br />"+e+"<br /><small>"+a+"</small>"),d3.select(".quick-stats.max-overall").html("<small>"+y+"</small><br />"+l.val.toFixed(2)+"<br /><small>"+v+"</small>")}function clearStatsRow(){d3.select(".quick-stats.recent").html("<small>--</small><br />Loading...<br /><small>--</small>"),d3.select(".quick-stats.count").html(""),d3.select(".quick-stats.max-currentyear").html(""),d3.select(".quick-stats.max-overall").html("")}function iconType(t){var e={};return"Rain"==t&&(e=greenIcon),"Well"==t&&(e=purpleIcon),"Flow"==t&&(e=orangeIcon),e}function loadSites(){d3.csv("./data/station_list.csv",function(t){return t.id=+t.G_ID,t.LAT=+t.LAT,t.LON=+t.LON,t},function(t,e){e=e.filter(function(t){return"Active"==t.STATUS});d3.select("#selected-station").on("change",selectChange).selectAll("option").data(e).enter().append("option").attr("value",function(t){return t.G_ID}).text(function(t){return t.SITE_CODE+": "+t.SITE_NAME+" ("+t.type+")"});sitelist=e,updateMapSites(e)})}function updateMapSites(t){t.forEach(function(t){if(!(isNaN(t.LAT)||isNaN(t.LON))&"Active"==t.STATUS){var e=L.marker([t.LAT,t.LON],{icon:iconType(t.type)});e.g_id=t.G_ID,e.on("click",onMarkerClick),e.addTo(sitemap)}}),plotSite(sitelist[0].G_ID)}function color(t){return c="",currentWY=calcWaterYear(new Date),+t==currentWY?c=maincolor:c=bgcolor,c}function handleMouseOver(t,e){currentLine=d3.select(this).attr("stroke-width",4).attr("stroke",selectcolor),d3.select(".x-axis .hoverText").text(t.year)}function handleMouseOut(t,e){d3.select(this).attr("stroke-width",1.5).attr("stroke",color(t.year)),d3.select(".x-axis .hoverText").text("")}function calcWaterYear(t){var e=t.getFullYear(),a=t.getMonth(),r=e;return a>=9&&(r=e+1),r}function plotSite(t){d3.selectAll("g.x-axis").remove(),d3.selectAll("g.y-axis").remove(),svg.selectAll("path.valueLine").remove(),clearStatsRow();var e=_.filter(dailyData,{G_ID:t});if(e.length>0)updatePlot(t),updateStatsRow(e);else{var a="./data/g_id-"+t+".csv";d3.csv(a,function(t){return t.val=t.val.length>0?+t.val:"-",t.day=parseDate(t.day),t.wy=calcWaterYear(t.day),t},function(e,a){dailyData=dailyData.concat(a),updatePlot(t),updateStatsRow(a)})}}function updatePlot(t){var e=_.filter(dailyData,{G_ID:t}),a=_.groupBy(e,"wy"),r=_.keys(a),i=[],n=sitelist.filter(function(e){return e.G_ID==t})[0],l=n.type;r.forEach(function(t,e){i.push({year:t,points:_.sortBy(a[t],["day"])})}),"Rain"==l&!("Y"==n.cumCalculated)&&(i.forEach(function(t){var e=0;t.points.forEach(function(t){t.oldval=t.val,t.val=e+t.oldval,e=t.val})}),n.cumCalculated="Y"),r.forEach(function(t){x_scales["scale"+t]=d3.scaleTime().domain([new Date(t-1,10,1),new Date(t,9,30)]).rangeRound([margin.left,width])}),y.rangeRound([height,0]),y.domain(d3.extent(e,function(t){return t.val})),g.append("g").attr("class","x-axis").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x_scales["scale"+_.max(r)]).tickFormat(d3.timeFormat("%b"))).select(".domain").remove(),g.append("g").call(d3.axisLeft(y)).attr("class","y-axis").append("text").attr("fill","#000").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.8em").attr("text-anchor","end").text("Rain"==l?"Rainfall (inches)":"Water Level (feet)"),g.selectAll("valueLine").data(i).enter().append("path").attr("class","valueLine").attr("stroke",function(t,e){return color(t.year)}).attr("d",function(t){return thisYear="scale"+t.year,line(t.points)}).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("fill","none").on("mouseover",handleMouseOver).on("mouseout",handleMouseOut),d3.select("g.x-axis").append("text").attr("class","hoverText").attr("fill","#000").attr("y",-20).attr("x",width-20).attr("dy","0.8em").attr("text-anchor","end")}function setSVGSize(){svg.attr("width",document.getElementById("mapid").offsetWidth).attr("height",document.getElementById("mapid").offsetHeight),width=+svg.attr("width")-margin.left-margin.right,height=+svg.attr("height")-margin.top-margin.bottom}function resize(){setSVGSize(),g_id=d3.select("#selected-station").property("value"),plotSite(g_id)}var sitelist={},dailyData=[],displayDateFormat=d3.timeFormat("%Y-%m-%d"),sitemap=L.map("mapid").setView([47.04,-122.9],10),layer=new L.StamenTileLayer("toner");sitemap.addLayer(layer);var CircleIcon=L.Icon.extend({options:{shadowUrl:"./img/marker/shadow_circle.png",iconSize:[15,15],shadowSize:[15,15],iconAnchor:[7.5,7.5],shadowAnchor:[5,5],popupAnchor:[15,15]}}),greenIcon=new CircleIcon({iconUrl:"./img/marker/green_circle.png"}),purpleIcon=new CircleIcon({iconUrl:"./img/marker/purple_circle.png"}),orangeIcon=new CircleIcon({iconUrl:"./img/marker/orange_circle.png"}),highlightIcon=L.icon({iconUrl:"./img/marker/highlight_circle.png",iconSize:[10,10],shadowSize:[10,10],iconAnchor:[5,5],shadowAnchor:[10,10],popupAnchor:[10,10]}),highlightMarker=L.marker({icon:highlightIcon}),parseDate=d3.timeParse("%Y-%m-%d %H:%M:%S"),svg=d3.select("svg").attr("width",document.getElementById("mapid").offsetWidth).attr("height",document.getElementById("mapid").offsetHeight),margin={top:20,right:10,bottom:30,left:50},width=+svg.attr("width")-margin.left-margin.right,height=+svg.attr("height")-margin.top-margin.bottom,bisectDate=d3.bisector(function(t){return t.date}).left,g=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),x_scales={},y=d3.scaleLinear(),thisYear,years=[];bgcolor="#d9d9d9",maincolor="#525252",selectcolor="red";var line=d3.line().x(function(t){return x_scales[thisYear](t.day)}).y(function(t){return y(t.val)});d3.select(window).on("resize",resize),loadSites();
//# sourceMappingURL=all.js.map
