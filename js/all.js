function selectChange(){g_id=d3.select("#selected-station").property("value"),selectSite(sitelist,g_id)}function onMarkerClick(e){selectSite(sitelist,e.target.g_id)}function selectSite(e,t){var a=e.filter(function(e){return e.G_ID===t})[0];d3.select("#selected-station").property("value",t),sitemap.panTo([a.LAT,a.LON]),highlightMarker.setLatLng([a.LAT,a.LON]),highlightMarker.setIcon(highlightIcon),highlightMarker.addTo(sitemap),plotSite(t)}function updateStatsRow(e){var t,a,r=d3.timeFormat("%b %e, %Y"),i=d3.timeFormat("%Y"),n=sitelist.filter(function(t){return t.G_ID===e[0].G_ID})[0],l=_.maxBy(e,"val"),o=_.maxBy(e,"day"),s=_.uniqBy(e,"wy"),c=s.length,d=_.maxBy(s,"wy").wy,g=calcWaterYear(new Date),h=_.filter(e,{wy:g});if(d===g){var m={};if("Rain"===n.type)m=_.maxBy(h,"oldval"),t=m.oldval.toFixed(2);else{var m=_.maxBy(h,"val");t=m.val.toFixed(2)}a=r(m.day)}else t="No Data",a="--";var u="Most Recent",p="",y="Max This Year",f="Highest Recorded",v=r(l.day);"Rain"==n.type&&(u="Inches This Year",p="As Of ",y="Wettest Day This Year",f="Wettest Year",v=i(l.day)),d3.select(".quick-stats.recent").html("<small>"+u+"</small><br />"+o.val.toFixed(2)+" <br /><small>"+p+r(o.day)+"</small>"),d3.select(".quick-stats.count").html("<small>Years Measured</small><br />"+c),d3.select(".quick-stats.max-currentyear").html("<small>"+y+"</small><br />"+t+"<br /><small>"+a+"</small>"),d3.select(".quick-stats.max-overall").html("<small>"+f+"</small><br />"+l.val.toFixed(2)+"<br /><small>"+v+"</small>")}function clearStatsRow(){d3.select(".quick-stats.recent").html("<small>--</small><br />Loading...<br /><small>--</small>"),d3.select(".quick-stats.count").html(""),d3.select(".quick-stats.max-currentyear").html(""),d3.select(".quick-stats.max-overall").html("")}function iconType(e){var t={};return"Rain"==e&&(t=greenIcon),"Well"==e&&(t=purpleIcon),"Flow"==e&&(t=orangeIcon),t}function loadSites(){d3.csv("./data/station_list.csv",function(e){return e.id=+e.G_ID,e.LAT=+e.LAT,e.LON=+e.LON,e},function(e,t){t=t.filter(function(e){return"Active"==e.STATUS});d3.select("#selected-station").on("change",selectChange).selectAll("option").data(t).enter().append("option").attr("value",function(e){return e.G_ID}).text(function(e){return e.SITE_CODE+": "+e.SITE_NAME+" ("+e.type+")"});sitelist=t,updateMapSites(t)})}function updateMapSites(e){e.forEach(function(e){if(!(isNaN(e.LAT)||isNaN(e.LON))&"Active"==e.STATUS){var t=L.marker([e.LAT,e.LON],{icon:iconType(e.type)});t.g_id=e.G_ID,t.on("click",onMarkerClick),t.addTo(sitemap)}}),plotSite(sitelist[0].G_ID)}function SelectYearChange(){wy=d3.select("#selected-wy").property("value"),highlightYear(wy)}function highlightYear(e){d3.selectAll("svg path.valueLine").classed("highlight",!1),d3.select("svg path.wy"+e).classed("highlight",!0),d3.select("#selected-wy").property("value",e)}function calcWaterYear(e){var t=e.getFullYear(),a=e.getMonth(),r=t;return a>=9&&(r=t+1),r}function plotSite(e){d3.selectAll("g.x-axis").remove(),d3.selectAll("g.y-axis").remove(),svg.selectAll("path.valueLine").remove(),clearStatsRow();var t=_.filter(dailyData,{G_ID:e});if(t.length>0)updatePlot(e),updateStatsRow(t);else{var a="./data/g_id-"+e+".csv";d3.csv(a,function(e){return e.val=e.val.length>0?+e.val:"-",e.day=parseDate(e.day),e.wy=calcWaterYear(e.day),e},function(t,a){dailyData=dailyData.concat(a),updatePlot(e),updateStatsRow(a)})}}function updatePlot(e){var t=_.filter(dailyData,{G_ID:e}),a=_.groupBy(t,"wy");years=_.keys(a);var r=[],i=d3.select("#selected-wy").on("change",SelectYearChange).selectAll("option").data(years,function(e){return e});i.enter().append("option").attr("value",function(e){return e}).text(function(e){return e}),i.exit().remove();var n=sitelist.filter(function(t){return t.G_ID==e})[0],l=n.type;years.forEach(function(e,t){r.push({year:e,points:_.sortBy(a[e],["day"])})}),"Rain"==l&!("Y"==n.cumCalculated)&&(r.forEach(function(e){var t=0;e.points.forEach(function(e){e.oldval=e.val,e.val=t+e.oldval,t=e.val})}),n.cumCalculated="Y"),years.forEach(function(e){x_scales["scale"+e]=d3.scaleTime().domain([new Date(e-1,10,1),new Date(e,9,30)]).rangeRound([margin.left,width])}),y.rangeRound([height,0]),y.domain(d3.extent(t,function(e){return e.val})),g.append("g").attr("class","x-axis").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x_scales["scale"+_.max(years)]).tickFormat(d3.timeFormat("%b"))).select(".domain").remove(),g.append("g").call(d3.axisLeft(y)).attr("class","y-axis").append("text").attr("fill","#000").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.8em").attr("text-anchor","end").text("Rain"==l?"Rainfall (inches)":"Water Level (feet)"),g.selectAll(".valueLine").data(r).enter().append("path").attr("class",function(e,t){return"valueLine wy"+e.year}).classed("currentwy",function(e){return(new Date).getFullYear()==+e.year}).attr("d",function(e){return thisYear="scale"+e.year,line(e.points)}).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("fill","none").on("mouseover",function(e){highlightYear(e.year)}),d3.select("g.x-axis").append("text").attr("class","hoverText").attr("fill","#000").attr("y",-20).attr("x",width-20).attr("dy","0.8em").attr("text-anchor","end")}function setSVGSize(){svg.attr("width",document.getElementById("mapid").offsetWidth).attr("height",document.getElementById("mapid").offsetHeight),width=+svg.attr("width")-margin.left-margin.right,height=+svg.attr("height")-margin.top-margin.bottom}function resize(){setSVGSize(),g_id=d3.select("#selected-station").property("value"),plotSite(g_id)}var sitelist={},dailyData=[],displayDateFormat=d3.timeFormat("%Y-%m-%d"),sitemap=L.map("mapid").setView([47.04,-122.9],10),layer=new L.StamenTileLayer("toner");sitemap.addLayer(layer);var CircleIcon=L.Icon.extend({options:{shadowUrl:"./img/marker/shadow_circle.png",iconSize:[15,15],shadowSize:[15,15],iconAnchor:[7.5,7.5],shadowAnchor:[5,5],popupAnchor:[15,15]}}),greenIcon=new CircleIcon({iconUrl:"./img/marker/green_circle.png"}),purpleIcon=new CircleIcon({iconUrl:"./img/marker/purple_circle.png"}),orangeIcon=new CircleIcon({iconUrl:"./img/marker/orange_circle.png"}),highlightIcon=L.icon({iconUrl:"./img/marker/highlight_circle.png",iconSize:[10,10],shadowSize:[10,10],iconAnchor:[5,5],shadowAnchor:[10,10],popupAnchor:[10,10]}),highlightMarker=L.marker({icon:highlightIcon}),legend=L.control({position:"bottomright"});legend.onAdd=function(e){for(var t=L.DomUtil.create("div","info legend"),a=["green_circle.png","purple_circle.png","orange_circle.png"],r=["Rain","Well","Flow"],i=0;i<a.length;i++)t.innerHTML+='<img src="./img/marker/'+a[i]+'"></img>  '+r[i]+"<br />";return t},legend.addTo(sitemap);var parseDate=d3.timeParse("%Y-%m-%d %H:%M:%S"),svg=d3.select("svg").attr("width",document.getElementById("mapid").offsetWidth).attr("height",document.getElementById("mapid").offsetHeight),margin={top:20,right:10,bottom:30,left:50},width=+svg.attr("width")-margin.left-margin.right,height=+svg.attr("height")-margin.top-margin.bottom,bisectDate=d3.bisector(function(e){return e.date}).left,g=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),x_scales={},y=d3.scaleLinear(),thisYear,years=[];bgcolor="#d9d9d9",maincolor="#525252",selectcolor="red";var line=d3.line().x(function(e){return x_scales[thisYear](e.day)}).y(function(e){return y(e.val)});d3.select(window).on("resize",resize),loadSites();
//# sourceMappingURL=all.js.map
