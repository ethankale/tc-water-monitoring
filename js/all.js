function selectChange(){g_id=d3.select("#selected-station").property("value"),selectSite(sitelist,g_id)}function onMarkerClick(t){selectSite(sitelist,t.target.g_id)}function selectSite(t,e,l){void 0===l&&(url=window.location.href,url.split("?").length>1&&(url=url.split("?")[0]),window.history.pushState({site:e},"TC Water Monitoring","/?site="+e));var a=t.filter(function(t){return t.G_ID===e})[0];d3.select("#selected-station").property("value",e),sitemap.panTo([a.LAT,a.LON]),highlightMarker.setLatLng([a.LAT,a.LON]),highlightMarker.setIcon(highlightIcon),highlightMarker.addTo(sitemap),plotSite(e)}function updateStatsRow(t){var e,l,a=d3.timeFormat("%b %e, %Y"),s=d3.timeFormat("%Y"),i=sitelist.filter(function(e){return e.G_ID===t[0].G_ID})[0],r=_.maxBy(t,"val"),o=_.maxBy(t,"day"),n=_.uniqBy(t,"wy"),c=n.length,d=_.maxBy(n,"wy").wy,m=calcWaterYear(new Date),h=_.filter(t,{wy:m});if(d===m){var u={};if("Rain"===i.type)u=_.maxBy(h,"oldval"),e=u.oldval.toFixed(2);else{var u=_.maxBy(h,"val");e=u.val.toFixed(2)}l=a(u.day)}else e="No Data",l="--";var y="Most Recent",g="",p="Max This Year",v="Highest Recorded",f=a(r.day);"Rain"==i.type&&(y="Inches This Year",g="As Of ",p="Wettest Day This Year",v="Wettest Year",f=s(r.day)),d3.select(".quick-stats.recent").html("<small>"+y+"</small><br />"+o.val.toFixed(2)+" <br /><small>"+g+a(o.day)+"</small>"),d3.select(".quick-stats.count").html("<small>Years Measured</small><br />"+c),d3.select(".quick-stats.max-currentyear").html("<small>"+p+"</small><br />"+e+"<br /><small>"+l+"</small>"),d3.select(".quick-stats.max-overall").html("<small>"+v+"</small><br />"+r.val.toFixed(2)+"<br /><small>"+f+"</small>")}function clearStatsRow(){d3.select(".quick-stats.recent").html("<small>--</small><br />Loading...<br /><small>--</small>"),d3.select(".quick-stats.count").html(""),d3.select(".quick-stats.max-currentyear").html(""),d3.select(".quick-stats.max-overall").html("")}var sitelist={},dailyData=[],current_site="";window.onpopstate=function(t){if(t.state){console.log(t.state);var e=window.location.href;e.split("?").length>1&&(g_id=e.split("?")[1].split("=")[1],selectSite(sitelist,g_id,"popstate"))}};
function iconType(e){var n={};return"Rain"==e&&(n=greenIcon),"Well"==e&&(n=purpleIcon),"Flow"==e&&(n=orangeIcon),n}function loadSites(){d3.csv("./data/station_list.csv",function(e){return e.id=+e.G_ID,e.LAT=+e.LAT,e.LON=+e.LON,e},function(e,n){n=n.filter(function(e){return"Active"==e.STATUS});d3.select("#selected-station").on("change",selectChange).selectAll("option").data(n).enter().append("option").attr("value",function(e){return e.G_ID}).text(function(e){return e.SITE_CODE+": "+e.SITE_NAME+" ("+e.type+")"});sitelist=n,updateMapSites(n)})}function updateMapSites(e){e.forEach(function(e){if(!(isNaN(e.LAT)||isNaN(e.LON))&"Active"==e.STATUS){var n=L.marker([e.LAT,e.LON],{icon:iconType(e.type)});n.g_id=e.G_ID,n.on("click",onMarkerClick),n.addTo(sitemap)}});var n=sitelist[0].G_ID;plotSite(n)}var displayDateFormat=d3.timeFormat("%Y-%m-%d"),sitemap=L.map("mapid").setView([47.04,-122.9],10),layer=new L.StamenTileLayer("toner");sitemap.addLayer(layer);var SiteIcon=L.Icon.extend({options:{iconSize:[15,15],shadowSize:[15,15],iconAnchor:[7.5,7.5],shadowAnchor:[5,5],popupAnchor:[15,15]}}),greenIcon=new SiteIcon({iconUrl:"./img/marker/green_circle.png",shadowURL:"./img/marker/shadow_circle.png"}),purpleIcon=new SiteIcon({iconUrl:"./img/marker/purple_triangle.png",shadowURL:"./img/marker/shadow_triangle.png"}),orangeIcon=new SiteIcon({iconUrl:"./img/marker/orange_square.png",shadowURL:"./img/marker/shadow_square.png"}),highlightIcon=L.icon({iconUrl:"./img/marker/highlight_circle.png",iconSize:[10,10],shadowSize:[10,10],iconAnchor:[5,5],shadowAnchor:[10,10],popupAnchor:[10,10]}),highlightMarker=L.marker({icon:highlightIcon}),legend=L.control({position:"bottomright"});legend.onAdd=function(e){for(var n=L.DomUtil.create("div","info legend"),i=["green_circle.png","purple_triangle.png","orange_square.png"],r=["Rain","Well","Flow"],o=0;o<i.length;o++)n.innerHTML+='<img src="./img/marker/'+i[o]+'"></img>  '+r[o]+"<br />";return n},legend.addTo(sitemap);
function SelectYearChange(){wy=d3.select("#selected-wy").property("value"),highlightYear(wy)}function highlightYear(t){d3.selectAll("svg path.valueLine").classed("highlight",!1),"Clear"!=t&&(d3.select("svg path.wy"+t).classed("highlight",!0),d3.select("#selected-wy").property("value",t))}function hoverYear(t){d3.select(".x-axis .hoverText").text(t),d3.select("svg path.wy"+t).classed("hover",!0)}function unHoverYear(t){d3.select(".x-axis .hoverText").text(""),d3.select("svg path.wy"+t).classed("hover",!1)}function calcWaterYear(t){var e=t.getFullYear(),a=t.getMonth(),r=e;return a>=9&&(r=e+1),r}function plotSite(t){d3.selectAll("g.x-axis").remove(),d3.selectAll("g.y-axis").remove(),svg.selectAll("path.valueLine").remove(),clearStatsRow();var e=_.filter(dailyData,{G_ID:t});if(e.length>0)updatePlot(t),updateStatsRow(e);else{var a="./data/g_id-"+t+".csv";d3.csv(a,function(t){return t.val=t.val.length>0?+t.val:"-",t.day=parseDate(t.day),t.wy=calcWaterYear(t.day),t},function(e,a){dailyData=dailyData.concat(a),updatePlot(t),updateStatsRow(a)})}}function updatePlot(t){var e=_.filter(dailyData,{G_ID:t}),a=_.groupBy(e,"wy");years=_.keys(a);var r=_.clone(years),n=[];r.push("Clear");var l=d3.select("#selected-wy").on("change",SelectYearChange).selectAll("option").data(r,function(t){return t});l.enter().append("option").attr("value",function(t){return t}).text(function(t){return t}),l.exit().remove(),d3.select("#selected-wy").property("value","Clear");var i=sitelist.filter(function(e){return e.G_ID==t})[0],o=i.type;years.forEach(function(t,e){n.push({year:t,points:_.sortBy(a[t],["day"])})}),"Rain"==o&!("Y"==i.cumCalculated)&&(n.forEach(function(t){var e=0;t.points.forEach(function(t){t.oldval=t.val,t.val=e+t.oldval,e=t.val})}),i.cumCalculated="Y"),years.forEach(function(t){x_scales["scale"+t]=d3.scaleTime().domain([new Date(t-1,10,1),new Date(t,9,30)]).rangeRound([margin.left,width])}),y.rangeRound([height,0]),y.domain(d3.extent(e,function(t){return t.val})),g.append("g").attr("class","x-axis").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x_scales["scale"+_.max(years)]).tickFormat(d3.timeFormat("%b"))).select(".domain").remove(),g.append("g").call(d3.axisLeft(y)).attr("class","y-axis").append("text").attr("fill","#000").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.8em").attr("text-anchor","end").text("Rain"==o?"Rainfall (inches)":"Water Level (feet)"),g.selectAll(".valueLine").data(n).enter().append("path").attr("class",function(t,e){return"valueLine wy"+t.year}).classed("currentwy",function(t){return(new Date).getFullYear()==+t.year}).attr("d",function(t){return thisYear="scale"+t.year,line(t.points)}).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("fill","none").on("mouseover",function(t){hoverYear(t.year)}).on("mouseout",function(t){unHoverYear(t.year)}).on("click",function(t){highlightYear(t.year)}),d3.select("g.x-axis").append("text").attr("class","hoverText").attr("fill","#000").attr("y",-20).attr("x",width-20).attr("dy","0.8em").attr("text-anchor","end")}function setSVGSize(){svg.attr("width",document.getElementById("mapid").offsetWidth).attr("height",document.getElementById("mapid").offsetHeight),width=+svg.attr("width")-margin.left-margin.right,height=+svg.attr("height")-margin.top-margin.bottom}function resize(){setSVGSize(),g_id=d3.select("#selected-station").property("value"),plotSite(g_id)}var parseDate=d3.timeParse("%Y-%m-%d %H:%M:%S"),svg=d3.select("svg").attr("width",document.getElementById("mapid").offsetWidth).attr("height",document.getElementById("mapid").offsetHeight),margin={top:20,right:10,bottom:30,left:50},width=+svg.attr("width")-margin.left-margin.right,height=+svg.attr("height")-margin.top-margin.bottom,bisectDate=d3.bisector(function(t){return t.date}).left,g=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),x_scales={},y=d3.scaleLinear(),thisYear,years=[];bgcolor="#d9d9d9",maincolor="#525252",selectcolor="red";var line=d3.line().x(function(t){return x_scales[thisYear](t.day)}).y(function(t){return y(t.val)});d3.select(window).on("resize",resize),loadSites();
//# sourceMappingURL=all.js.map
